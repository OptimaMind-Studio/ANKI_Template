<div class="cornell-layout">
    <div class="cornell-header" style="position: relative;">
      <div style="position: absolute; left: 12px; top: 8px; color: #d32f2f; font-family: 'KaiTi', 'æ¥·ä½“', STKaiti, serif; font-weight: bold; font-size: 15px; opacity: 0.9; line-height: 1;">
        {{Field}}
      </div>
      <div style="position: absolute; right: 12px; bottom: 6px; color: #1976d2; font-family: 'KaiTi', 'æ¥·ä½“', STKaiti, serif; font-weight: bold; font-size: 12px; opacity: 0.9; line-height: 1;">
        {{Taxonomy}}
      </div>
      <div id="name-text-only">{{Name}}</div>
    </div>
  
    <div class="cornell-left">
      <span class="label">REFERENCES</span>
      <div id="ref-links-container" class="ref-content" style="word-break: break-all; margin-bottom: 20px;">{{References}}</div>
      <hr style="border: 0; border-top: 1px solid #f0f4eb; margin: 15px 0;">
      <span class="label">AI Notes</span>
      <div class="ai-controls" style="margin-bottom: 8px;">
        <button id="btn-zh">åªæ˜¾ç¤ºä¸­æ–‡</button>
        <button id="btn-en">åªæ˜¾ç¤ºè‹±æ–‡</button>
        <button id="btn-mix">åŸå§‹å†…å®¹</button>
      </div>
      <div class="ai-content">{{AINotes}}</div>
    </div>
  
    <div class="cornell-right">
      <span class="label">MY NOTES</span>
      <div class="my-content">{{MyNotes}}</div>
    </div>
  </div>
  
  <script>
  (function() {
    // ===== 0. AI Notes å¤„ç†é€»è¾‘ =====
    var aiNode = document.querySelector('.ai-content');
    if (aiNode) {
      var originalHTML = aiNode.innerHTML;
  
      // Header å‡çº§å‡½æ•°ï¼šå°† h1-h6 æå‡è‡³ h4-h5
      function processHeaders(node) {
        node.innerHTML = node.innerHTML
          .replace(/<h([1-6])>/gi, function(match, level) {
            var newLevel = Math.min(parseInt(level) + 3, 5);
            return '<h' + newLevel + '>';
          })
          .replace(/<\/h([1-6])>/gi, function(match, level) {
            var newLevel = Math.min(parseInt(level) + 3, 5);
            return '</h' + newLevel + '>';
          });
      }
  
      // ä¸­è‹±æ–‡æ‹†åˆ†å‡½æ•°ï¼šå°†çº¯æ–‡æœ¬åŒ…è£…åœ¨ span.zh æˆ– span.en ä¸­
      function splitChineseEnglishNode(node) {
        if (node.nodeType === Node.TEXT_NODE) {
          var text = node.nodeValue;
          if (text.trim() === '') return;
          var frag = document.createDocumentFragment();
          var regex = /([\u4e00-\u9fffï¼Œã€‚ï¼ï¼Ÿï¼šï¼›ã€Šã€‹â€œâ€â€˜â€™â€”â€”â€¦ã€]+|[A-Za-z0-9.,!?:;"\'\s]+)/g;
          var match;
          while ((match = regex.exec(text)) !== null) {
            var span = document.createElement('span');
            if (/[\u4e00-\u9fff]/.test(match[0])) {
              span.className = 'zh';
            } else {
              span.className = 'en';
            }
            span.textContent = match[0];
            frag.appendChild(span);
          }
          node.parentNode.replaceChild(frag, node);
        } else if (node.nodeType === Node.ELEMENT_NODE) {
          Array.from(node.childNodes).forEach(splitChineseEnglishNode);
        }
      }
  
      // åˆå§‹åŒ–ï¼šæ‰§è¡Œ Header å‡çº§ï¼Œå¹¶é»˜è®¤æ‰§è¡Œæ‹†åˆ†ï¼ˆä¸ºäº†åˆå§‹ç‚¹å‡»æŒ‰é’®æœ‰æ•ˆï¼‰
      processHeaders(aiNode);
      splitChineseEnglishNode(aiNode);
  
      var btnZh = document.getElementById('btn-zh');
      var btnEn = document.getElementById('btn-en');
      var btnMix = document.getElementById('btn-mix');
  
      // ç»Ÿä¸€çš„å¤„ç†å‡½æ•°ï¼Œç¡®ä¿ç‚¹å‡»æŒ‰é’®æ—¶å¦‚æœ DOM æ²¡æ‹†åˆ†åˆ™å…ˆæ‹†åˆ†
      function ensureSplitAndFilter(showClass, hideClass) {
        // æ¯æ¬¡åˆ‡æ¢å‰å…ˆæ¢å¤åŸå§‹çŠ¶æ€é‡æ–°æ‹†åˆ†ï¼Œç¡®ä¿é€»è¾‘çº¯å‡€
        aiNode.innerHTML = originalHTML;
        processHeaders(aiNode);
        splitChineseEnglishNode(aiNode);
        
        aiNode.querySelectorAll('.' + showClass).forEach(s => s.style.display = 'inline');
        aiNode.querySelectorAll('.' + hideClass).forEach(s => s.style.display = 'none');
      }
  
      btnZh && btnZh.addEventListener('click', function() {
        ensureSplitAndFilter('zh', 'en');
      });
  
      btnEn && btnEn.addEventListener('click', function() {
        ensureSplitAndFilter('en', 'zh');
      });
  
      btnMix && btnMix.addEventListener('click', function() {
        // æ ¸å¿ƒéœ€æ±‚ï¼šç›´æ¥æ˜¾ç¤ºåŸå§‹æ ¼å¼ï¼Œä¸å¸¦ä»»ä½•æ‹†åˆ†çš„ span æ ‡ç­¾
        aiNode.innerHTML = originalHTML;
        processHeaders(aiNode);
      });
    }
  
    // ===== 1. å¤„ç†åå­—åˆ†è¡Œ =====
    var nameNode = document.getElementById('name-text-only');
    if (nameNode) {
      var nameText = nameNode.innerText.trim();
      var nameMatch = nameText.match(/([^\x00-\xff]+)\s*([A-Za-z].*)/);
      if (nameMatch) {
        nameNode.innerHTML = '<div>' + nameMatch[1].trim() + '</div>' +
          '<div style="font-size:14px; font-weight:normal; opacity:0.7; margin-top:4px;">' + nameMatch[2].trim() + '</div>';
      }
    }
  
    // ===== 2. References åŒºåŸŸå¤„ç† =====
    var refContainer = document.getElementById('ref-links-container');
    if (refContainer) {
      var rawContent = refContainer.innerText.trim();
      if (rawContent && rawContent !== "{{References}}") {
        var lines = rawContent.split(/\n|<br>|<div>/);
        var resultHtml = "";
        lines.forEach(function(line) {
          var item = line.replace(/<\/div>/g, "").trim();
          var linkMatch = item.match(/^([a-z0-9]+):\/\/(.*)/i);
          if (linkMatch) {
            var protocol = linkMatch[1].toLowerCase();
            var rest = linkMatch[2];
            var displayName = "";
            var icon = "ğŸ”—";
            if (protocol === "obsidian") {
              var fileMatch = item.match(/file=([^&]+)/);
              displayName = fileMatch ? decodeURIComponent(fileMatch[1]) : "Obsidian Note";
              displayName = displayName.replace(/\//g, " â€º ");
            } else if (protocol === "anki") {
              displayName = "Anki: " + decodeURIComponent(rest).split(/[?&]/)[0];
              icon = "ğŸ“‡";
            } else {
              displayName = protocol.toUpperCase() + " Link";
            }
            resultHtml += '<div style="margin-top:4px;"><a href="' + item + '" style="color: #2d5a27; text-decoration: none; font-size: 13px; border-bottom: 1px dashed #2d5a27;">' + icon + ' ' + displayName + '</a></div>';
          } else if (item.length > 0) {
            resultHtml += '<div style="font-size: 13px; color: #666;">' + item + '</div>';
          }
        });
        refContainer.innerHTML = resultHtml;
      }
    }
  
    // ===== 3. MyNotes éƒ¨åˆ†é“¾æ¥è½¬æ¢ =====
    var notesNode = document.querySelector('.my-content');
    if (notesNode) {
      var html = notesNode.innerHTML;
      var regex = /([a-z0-9]+:\/\/[^\s<]+)/gi;
      var newHtml = html.replace(regex, function(url) {
        var protocolMatch = url.match(/^([a-z0-9]+):\/\//i);
        var protocol = protocolMatch ? protocolMatch[1].toLowerCase() : "";
        var displayName = "Link";
        var icon = "ğŸ”—";
        if (protocol === "obsidian") {
          var fileMatch = url.match(/file=([^&]+)/);
          displayName = fileMatch ? decodeURIComponent(fileMatch[1]).replace(/\//g, " â€º ") : "Obsidian Note";
        } else if (protocol === "anki") {
          icon = "ğŸ“‡";
          displayName = "Anki Note";
        }
        return '<a href="' + url + '" style="color: #1976d2; text-decoration: none; border-bottom: 1px dashed #1976d2; font-style: normal;">' + icon + ' ' + displayName + '</a>';
      });
      notesNode.innerHTML = newHtml;
    }
  })();
  </script>