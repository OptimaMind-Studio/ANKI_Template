<div class="cornell-layout">
  <div class="cornell-header" id="card-top">
    <div style="position: absolute; left: 12px; top: 8px; color: #d32f2f; font-family: 'KaiTi', 'æ¥·ä½“', STKaiti, serif; font-weight: bold; font-size: 15px; opacity: 0.9; line-height: 1;">
      {{Field}}
    </div>
    <div style="position: absolute; right: 12px; top: 8px; color: #000000; font-family: 'KaiTi', 'æ¥·ä½“', STKaiti, serif; font-weight: bold; font-size: 12px; opacity: 0.9; line-height: 1;">
      {{Source}}
    </div>
    <div style="position: absolute; right: 12px; bottom: 6px; color: #1976d2; font-family: 'KaiTi', 'æ¥·ä½“', STKaiti, serif; font-weight: bold; font-size: 12px; opacity: 0.9; line-height: 1;">
      {{Taxonomy}}
    </div>
    <div id="name-text-only">{{Name}}</div>
  </div>

  <div class="cornell-left">
    <div id="outline-container">
      <span class="label">OUTLINE</span>
      <div id="outline-content" class="outline-content"></div>
      <hr style="border: 0; border-top: 1px solid #f0f4eb; margin: 15px 0;">
    </div>
    <span class="label">REFERENCES</span>
    <div id="ref-links-container" class="ref-content">{{References}}</div>
    <hr style="border: 0; border-top: 1px solid #f0f4eb; margin: 15px 0;">
    <span class="label">AI Notes</span>
    <div class="ai-controls">
      <button id="btn-zh">åªæ˜¾ç¤ºä¸­æ–‡</button>
      <button id="btn-en">åªæ˜¾ç¤ºè‹±æ–‡</button>
      <button id="btn-mix">åŸå§‹å†…å®¹</button>
    </div>
    <div id="ai-content-area" class="ai-content">{{AINotes}}</div>
  </div>

  <div id="my-notes-area" class="cornell-right">
    <span class="label">MY NOTES</span>
    <div class="my-content">{{MyNotes}}</div>
  </div>
</div>

<script>
(function() {
  var aiNode = document.getElementById('ai-content-area');
  var myNotesArea = document.getElementById('my-notes-area');
  var originalHTML = aiNode ? aiNode.innerHTML : "";

  // iPad è·³è½¬é€‚é…
  if (myNotesArea) {
    myNotesArea.addEventListener('click', function(e) {
      if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON' || e.target.closest('a')) return;
      document.getElementById('card-top').scrollIntoView({ behavior: 'smooth' });
      setTimeout(function() { if (window.scrollY > 100) window.scrollTo(0, 0); }, 300);
    });
  }

  function processHeaders(node) {
    if (!node) return;
    node.innerHTML = node.innerHTML.replace(/\[\|nid\d+\]/g, '')
      .replace(/<h([1-6])>/gi, (m, l) => '<h' + Math.min(parseInt(l) + 1, 3) + '>')
      .replace(/<\/h([1-6])>/gi, (m, l) => '</h' + Math.min(parseInt(l) + 1, 3) + '>');
  }

  function splitLang(node) {
    if (node.nodeType === 3) {
      var t = node.nodeValue; if (!t.trim()) return;
      var f = document.createDocumentFragment();
      var r = /([\u4e00-\u9fffï¼Œã€‚ï¼ï¼Ÿï¼šï¼›ã€Šã€‹â€œâ€â€˜â€™â€”â€”â€¦ã€]+|[A-Za-z0-9.,!?:;"\'\s]+)/g;
      var m; while ((m = r.exec(t)) !== null) {
        var s = document.createElement('span'); s.className = /[\u4e00-\u9fff]/.test(m[0]) ? 'zh' : 'en';
        s.textContent = m[0]; f.appendChild(s);
      }
      node.parentNode.replaceChild(f, node);
    } else if (node.nodeType === 1) Array.from(node.childNodes).forEach(splitLang);
  }

  function generateOutline() {
    var out = document.getElementById('outline-content');
    var heads = document.querySelectorAll('.ai-content h1, .ai-content h2, .ai-content h3, .my-content .custom-h3');
    if (heads.length === 0) { document.getElementById('outline-container').style.display = 'none'; return; }
    document.getElementById('outline-container').style.display = 'block';
    var h = ""; heads.forEach((el, i) => {
      var id = "nav-" + i; el.id = id;
      var lvl = el.tagName.toLowerCase(); if (el.classList.contains('custom-h3')) lvl = 'h3';
      h += '<a class="outline-item outline-'+lvl+'" data-target="'+id+'">'+el.innerText.trim()+'</a>';
    });
    out.innerHTML = h;
    out.querySelectorAll('.outline-item').forEach(el => el.onclick = function(e) {
      e.stopPropagation(); document.getElementById(this.dataset.target).scrollIntoView({ behavior: 'smooth' });
    });
  }

  if (aiNode) {
    processHeaders(aiNode); splitLang(aiNode);
    document.getElementById('btn-zh').onclick = () => filter('zh', 'en');
    document.getElementById('btn-en').onclick = () => filter('en', 'zh');
    document.getElementById('btn-mix').onclick = () => { aiNode.innerHTML = originalHTML; processHeaders(aiNode); generateOutline(); };
    function filter(s, h) {
      aiNode.innerHTML = originalHTML; processHeaders(aiNode); splitLang(aiNode);
      aiNode.querySelectorAll('.'+s).forEach(el => el.style.display = 'inline');
      aiNode.querySelectorAll('.'+h).forEach(el => el.style.display = 'none');
      generateOutline();
    }
  }

  var myC = document.querySelector('.my-content');
  if (myC) {
    myC.innerHTML = myC.innerHTML.replace(/(?:^|<br>|<div>)\s*###\s*(.*?)(\n|<br>|<\/div>|$)/gi, '<span class="custom-h3">$1</span>$2')
      .replace(/([a-z0-9]+:\/\/[^\s<]+)/gi, url => '<a href="'+url+'" style="color:#888;font-style:italic;font-size:12px;">ğŸ”— '+(url.includes("obsidian")?decodeURIComponent(url.split('/').pop().split('?')[0]):"Link")+'</a>');
  }

  var nameN = document.getElementById('name-text-only');
  if (nameN) {
    var nm = nameN.innerText.match(/([^\x00-\xff]+)\s*([A-Za-z].*)/);
    if (nm) nameN.innerHTML = '<div>'+nm[1]+'</div><div style="font-size:14px;opacity:0.7;margin-top:4px;">'+nm[2]+'</div>';
  }
  setTimeout(generateOutline, 100);
})();
</script>